"""
app.py - Flask web GUI for House Price Prediction

Run:
1. Ensure model/house_price_model.pkl exists (created by model_building.py)
2. python app.py
3. Open: http://127.0.0.1:5000
"""

from pathlib import Path
import joblib
import json
import pandas as pd
from flask import Flask, render_template, request, flash

ROOT = Path(__file__).resolve().parent
MODEL_PATH = ROOT / "model" / "house_price_model.pkl"
NEIGH_PATH = ROOT / "model" / "neighborhood_categories.json"

app = Flask(__name__)
app.secret_key = "replace-this-with-a-secure-random-key"

# Load model (pipeline) at startup
if not MODEL_PATH.exists():
    raise FileNotFoundError(f"Model not found. Train the model first: {MODEL_PATH}")
model = joblib.load(MODEL_PATH)

# Load neighborhood list if available
if NEIGH_PATH.exists():
    with open(NEIGH_PATH, "r", encoding="utf-8") as f:
        neighborhoods = json.load(f)
else:
    neighborhoods = []

@app.route("/", methods=["GET", "POST"])
def index():
    prediction = None
    error = None
    if request.method == "POST":
        try:
            # Get inputs from form and coerce to the same columns used in training
            data = {
                "OverallQual": float(request.form.get("OverallQual", 0)),
                "GrLivArea": float(request.form.get("GrLivArea", 0)),
                "TotalBsmtSF": float(request.form.get("TotalBsmtSF", 0)),
                "GarageCars": float(request.form.get("GarageCars", 0)),
                "YearBuilt": float(request.form.get("YearBuilt", 0)),
                "Neighborhood": request.form.get("Neighborhood", "")
            }
            X_input = pd.DataFrame([data])
            pred = model.predict(X_input)  # pipeline handles preprocessing
            price = float(pred[0])
            # Format as currency-like string
            prediction = f"${price:,.2f}"
        except Exception as e:
            error = str(e)
            flash(f"Error during prediction: {error}", "danger")
    return render_template("index.html", prediction=prediction, neighborhoods=neighborhoods, error=error)

if __name__ == "__main__":
    app.run(debug=True)
